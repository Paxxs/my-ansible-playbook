---
- name: 确保已提供用户密码
  ansible.builtin.assert:
    that:
      - (user_password | default('')) | length > 0
    fail_msg: "必须提供 user_password，可在 .secrets/init_my_server.yml（或通过 -e user_password=...）设置，避免将明文密码写入仓库。"

- name: 设置管理员组
  ansible.builtin.set_fact:
    admin_group: "{{ 'wheel' if ansible_os_family == 'RedHat' else 'sudo' }}"
  changed_when: false

- name: 计算 SELinux 状态
  ansible.builtin.set_fact:
    selinux_enabled: "{{ (ansible_selinux is defined) and (ansible_selinux.status == 'enabled') }}"
  changed_when: false

- name: 更新软件包索引 (apt)
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: "{{ init_upgrade_cache_valid_time }}"
  when:
    - init_upgrade_packages
    - ansible_pkg_mgr == "apt"

- name: 更新软件包索引 (dnf/yum)
  ansible.builtin.dnf:
    update_cache: true
  when:
    - init_upgrade_packages
    - ansible_pkg_mgr in ["dnf", "yum"]

- name: 全量升级软件包 (apt)
  ansible.builtin.apt:
    upgrade: dist
  when:
    - init_upgrade_packages
    - ansible_pkg_mgr == "apt"

- name: 全量升级软件包 (dnf/yum)
  ansible.builtin.dnf: # noqa package-latest
    name: "*"
    state: latest
    update_only: true
  when:
    - init_upgrade_packages
    - ansible_pkg_mgr in ["dnf", "yum"]

- name: 安装基础软件
  ansible.builtin.package:
    name: "{{ init_packages }}"
    state: present

- name: 创建用户
  ansible.builtin.user:
    name: "{{ user_name }}"
    shell: /bin/bash
    password: "{{ user_password | password_hash('sha512', user_password_salt) }}"
    create_home: true
    state: present

- name: 将用户加入管理员组
  ansible.builtin.user:
    name: "{{ user_name }}"
    groups: "{{ admin_group }}"
    append: true

- name: 在 .bashrc 中添加自动启动 fish 的配置
  ansible.builtin.blockinfile:
    path: "/home/{{ user_name }}/.bashrc"
    create: true
    owner: "{{ user_name }}"
    group: "{{ user_name }}"
    mode: "0644"
    block: |
      if [[ $(ps --no-header --pid=$PPID --format=comm) != "fish" && -z ${BASH_EXECUTION_STRING} && ${SHLVL} == 1 ]]
      then
        shopt -q login_shell && LOGIN_OPTION='--login' || LOGIN_OPTION=''
        exec fish $LOGIN_OPTION
      fi
    marker: "# {mark} ANSIBLE MANAGED BLOCK - fish auto start"

- name: 创建 /srv/apps 目录
  ansible.builtin.file:
    path: /srv/apps
    state: directory
    owner: "{{ user_name }}"
    group: "{{ admin_group }}"
    mode: "2770"
    setype: "{{ 'default_t' if selinux_enabled and ansible_os_family == 'RedHat' else omit }}"
