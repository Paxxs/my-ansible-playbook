---
- name: Load OS-pecific vars.
  ansible.builtin.include_vars: "{{ lookup('first_found', params) }}"
  vars:
    params:
      files:
        - '{{ ansible_facts.distribution }}.yml'
        - '{{ ansible_facts.os_family }}.yml'
        - main.yml
      paths:
        - 'vars'

- name: 显示收集到的发行版信息
  ansible.builtin.debug:
    msg: "Distribution: {{ ansible_facts.distribution }}, Version Codename: {{ docker_version_codename }}, OS Family: {{ ansible_facts.os_family }}"

- name: Include OS-specific setup tasks.
  ansible.builtin.include_tasks:
    file: setup-debian.yml
  when:
    - ansible_facts.os_family == "Debian"
    - docker_add_repo | bool

- name: Include OS-specific setup tasks.
  ansible.builtin.include_tasks:
    file: setup-rhel.yml
  when: ansible_facts.os_family == "RedHat"

- name: Install Docker packages.
  ansible.builtin.package:
    name: "{{ docker_packages }}"
    state: present

- name: Add user to docker group
  ansible.builtin.user:
    name: "{{ username }}"
    groups: docker
    append: true

- name: Ensure Docker service is started and enabled
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true

- name: Verify Docker installation
  ansible.builtin.command: docker --version
  register: docker_version
  changed_when: false

- name: Display Docker version
  ansible.builtin.debug:
    msg: "{{ docker_version.stdout }}"
