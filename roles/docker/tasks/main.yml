---
- name: Load OS-pecific vars.
  ansible.builtin.include_vars: "{{ lookup('first_found', params) }}"
  vars:
    params:
      files:
        - '{{ ansible_facts.distribution }}.yml'
        - '{{ ansible_facts.os_family }}.yml'
        - main.yml
      paths:
        - 'vars'

- name: 显示收集到的发行版信息
  ansible.builtin.debug:
    msg: "Distribution: {{ ansible_facts.distribution }}, Version Codename: {{ docker_version_codename }}, OS Family: {{ ansible_facts.os_family }}"

- name: Include OS-specific setup tasks.
  ansible.builtin.include_tasks:
    file: setup-debian.yml
  when:
    - ansible_facts.os_family == "Debian"
    - docker_add_repo | bool

- name: Include OS-specific setup tasks.
  ansible.builtin.include_tasks:
    file: setup-rhel.yml
  when: ansible_facts.os_family == "RedHat"

- name: Install Docker packages.
  ansible.builtin.package:
    name: "{{ docker_packages }}"
    state: present

- name: Check if there are any users to add to the docker group.
  block:
    - name: Get docker group info using getent.
      ansible.builtin.getent:
        database: group
        key: docker
        split: ':'
      when: docker_users | length > 0
    - name: Set flag if at least one user needs to be added to docker group
      ansible.builtin.set_fact:
        docker_at_least_one_user_to_modify: true
      when:
        - docker_users | length > 0
        - item not in ansible_facts.getent_group["docker"][2]
      with_items: "{{ docker_users }}"
    - name: Add users to docker group
      ansible.builtin.include_tasks: docker-users.yml
      when: docker_at_least_one_user_to_modify is defined

- name: Ensure Docker service is started and enabled
  ansible.builtin.service:
    name: docker
    state: started
    enabled: true

- name: Verify Docker installation
  ansible.builtin.command: docker --version
  register: docker_version
  changed_when: false

- name: Display Docker version
  ansible.builtin.debug:
    msg: "{{ docker_version.stdout }}"
